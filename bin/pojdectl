#!/bin/bash

# Define configuration scripts
configuration_scripts=(
    parameters
    user
    code-server
    ttyd
    novnc
    jupyter-lab
    nginx
    ssh
    webwormhole
    clean
)

# Parse command
case "$1" in
apply)
    # Remove the old container if it exists
    if [ -n "$(docker ps -q -f name=pojde-ng)" ]; then
        $0 remove
    fi

    # Check if we are on systemd or not
    docker_flags=()
    docker_args=()
    docker_image="pojntfx/pojde-ng:latest"
    if [ ! -n "$(which systemctl)" ]; then
        export docker_flags=(
            "-e"
            "POJDE_NG_OPENRC=true"
        )
        export docker_args=(
            "/sbin/openrc-init"
        )
        export docker_image="pojntfx/pojde-ng:latest-openrc"
    fi

    # Pull the newest image
    docker pull "${docker_image}"

    # Create the container
    docker run -d --name pojde-ng --privileged --restart always -v /sys/fs/cgroup:/sys/fs/cgroup:ro -v pojde-ng-preferences:/opt/pojde-ng/preferences:z -v pojde-ng-ca:/opt/pojde-ng/ca:z -p 18000-18004:8000-8004 -p 18022:8022 "${docker_flags[@]}" "${docker_image}" "${docker_args[@]}"

    # Run configuration scripts
    for script in "${configuration_scripts[@]}"; do
        docker exec -it "${docker_flags[@]}" pojde-ng /opt/pojde-ng/configuration/${script}.sh
    done
    ;;

start)
    # Start the container
    docker start pojde-ng
    ;;

stop)
    # Stop the container
    docker stop pojde-ng
    ;;

restart)
    # Restart the container
    docker restart pojde-ng
    ;;

remove)
    # Remove the container
    docker rm -f pojde-ng
    ;;

purge)
    # Remove the container and it's volumes
    $0 remove
    docker volume rm pojde-ng-preferences pojde-ng-ca
    ;;

logs)
    # Tail the logs
    if [ -n "$(docker exec -it pojde-ng which systemctl)" ]; then
        docker exec -it pojde-ng journalctl -f
    else
        docker logs -f pojde-ng
    fi
    ;;

enter)
    # Open a shell in the container
    docker exec -it pojde-ng bash
    ;;

update-pojdectl)
    # Self-Update pojdectl
    sudo curl -L -o /usr/bin/pojdectl https://raw.githubusercontent.com/pojntfx/pojde-ng/main/bin/pojdectl
    sudo chmod +x /usr/bin/pojdectl
    ;;

*)
    [ "$1" != '--help' ] && printf "Unknown command \"$1\".\n\n"

    echo "pojdectl is the management tool for pojde.

Usage:

    apply:              (Re-)creates the container, interactively configures it, and restarts it's services
    start:              Starts the container
    stop:               Stops the container
    restart:            Restarts the container
    remove:             Removes the container
    purge:              Removes the container and it's volumes
    logs:               Shows the system logs
    enter:              Opens a shell in the container
    update-pojdectl:    Updates pojdectl

For more information, please visit https://github.com/pojntfx/pojde-ng#Usage."
    ;;
esac
